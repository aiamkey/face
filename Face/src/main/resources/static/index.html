<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器学习系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"  rel="stylesheet">
    <link rel="icon" href="/image/index.png"  type="image/png">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"  rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
</head>
<body>
<!-- 顶部导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
        <div class="navbar-brand">机器学习系统</div>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#userCenterModal">
                        <i class="fas fa-user me-1"></i> 用户中心
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="logout">退出</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<br>
<br>
<!-- 左侧菜单 -->
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar">
            <div class="list-group list-group-flush mt-4">
                <a href="#" class="list-group-item list-group-item-action active" data-target="home">
                    <i class="fas fa-home me-2"></i>首页概览
                </a>
                <a href="#" class="list-group-item list-group-item-action" data-target="chat">
                    <i class="fas fa-comments me-2"></i>AI对话
                </a>
                <a href="#" class="list-group-item list-group-item-action" data-target="history">
                    <i class="fas fa-history me-2"></i>历史对话
                </a>
                <a href="#" class="list-group-item list-group-item-action" data-target="ml">
                    <i class="fas fa-brain me-2"></i>机器学习
                </a>
            </div>
        </div>

        <!-- 主内容区 -->
        <div id="content-wrapper" class="col-md-10 p-4">
            <!-- 首页内容（默认显示） -->
            <div id="home-page">
                <h2 class="mb-4" style="margin:0 auto">系统概览</h2>
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center shadow-sm">
                            <div class="text-body">
                                <h5 class="card-title">总用户数</h5>
                                <p class="card-counter">1,234</p>
                                <p class="text-muted">较上月增长 12%</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center shadow-sm">
                            <div class="text-body">
                                <h5 class="card-title">今日对话</h5>
                                <p class="card-counter">256</p>
                                <p class="text-muted">较昨日增长 8%</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center shadow-sm">
                            <div class="text-body">
                                <h5 class="card-title">活跃用户</h5>
                                <p class="card-counter">89</p>
                                <p class="text-muted">在线用户: 15</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <canvas id="visitTrend"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">系统状态</h5>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>CPU 使用率</span>
                                    <span class="text-primary" id="cpu-usage">N/A</span>
                                </div>
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 42%"></div>
                                </div>

                                <div class="d-flex justify-content-between mb-3">
                                    <span>内存使用</span>
                                    <span class="text-success" id="memory-usage">N/A</span>
                                </div>
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 65%"></div>
                                </div>

                                <div class="d-flex justify-content-between mb-3">
                                    <span>存储空间</span>
                                    <span class="text-warning" id="storage-usage">N/A</span>
                                </div>
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 78%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI对话内容（默认隐藏） -->
            <div id="chat-page" style="display: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-4" style="margin: auto">AI对话</h2>
                    <button id="clear-history" class="btn btn-outline-danger btn-sm">
                        清空历史
                    </button>
                </div>
                <iframe id="chat-iframe" src="chat.html"  class="page-iframe"></iframe>
            </div>

            <!-- 历史对话内容（默认隐藏） -->
            <div id="history-page" style="display: none;">
                <h2 class="mb-4">历史对话</h2>
                <iframe src="history.html" class="page-iframe"></iframe>
            </div>

            <!-- 机器学习内容（默认隐藏） -->
            <div id="ml-page" style="display: none;">
                <h2 class="mb-4">机器学习</h2>
                <iframe src="ml.html"  class="page-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- 用户中心模态框 -->
<div class="modal fade" id="userCenterModal" tabindex="-1" aria-labelledby="userCenterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userCenterModalLabel">用户中心</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe src="introduce.html"  style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script src="/js/chart.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', function () {
    // 菜单点击事件监听
    const sidebarItems = document.querySelectorAll('.sidebar  .list-group-item');
    const allPages = document.querySelectorAll('[id$="-page"]');

    // 存储iframe引用和加载状态
    let historyIframe = document.querySelector('#history-page  iframe');
    let iframeLoaded = false;

    // 初始化iframe加载监听
    if (historyIframe) {
        historyIframe.onload = function () {
            iframeLoaded = true;
            console.log('iframe 已加载完成');
        };
    }

    sidebarItems.forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault();
            const target = this.getAttribute('data-target');

            // 更新菜单项激活状态
            sidebarItems.forEach(el => el.classList.remove('active'));
            this.classList.add('active');

            // 切换页面显示
            allPages.forEach(page => page.style.display = 'none');
            document.getElementById(`${target}-page`).style.display = 'block';
        });
    });

    // 修改后的历史菜单点击处理
    document.querySelector('[data-target="history"]').addEventListener('click', function () {
        // 每次点击都重新获取iframe引用，确保是最新的
        historyIframe = document.querySelector('#history-page  iframe');

        if (historyIframe) {
            const sendMessage = function () {
                try {
                    historyIframe.contentWindow.postMessage('show', '*');
                    console.log(' 已发送show消息到iframe');
                } catch (e) {
                    console.error(' 发送消息失败:', e);
                }
            };

            // 重置加载状态
            iframeLoaded = false;

            // 重新绑定onload事件
            historyIframe.onload = function () {
                iframeLoaded = true;
                sendMessage();
            };

            // 如果iframe已经加载，直接发送
            if (historyIframe.contentWindow && iframeLoaded) {
                sendMessage();
            } else {
                // 强制重新加载iframe以确保每次都能触发onload
                historyIframe.src = historyIframe.src;
            }
        }
    });

    // 在DOMContentLoaded事件监听器中添加以下代码（可以放在其他事件监听器附近）
    document.getElementById('logout')?.addEventListener('click', function () {
        // 清除用户会话数据
        localStorage.removeItem('userToken');
        localStorage.removeItem('chatHistory');

        // 跳转到登录页或首页
        window.location.href = "/login";
    });

    // 初始化图表（保持不变）
    function initVisitChart() {
        const ctx = document.querySelector('#visitTrend').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
                datasets: [{
                    label: '访问量',
                    data: [65, 59, 80, 81, 56, 55, 40],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {position: 'top'},
                    title: {display: true, text: '访问量趋势'}
                },
                scales: {y: {beginAtZero: true}}
            }
        });
    }

    initVisitChart();

    // 清空历史按钮（保持不变）
    document.querySelector('#clear-history')?.addEventListener('click', function () {
        localStorage.removeItem('chatHistory');
        location.reload();
        alert('历史对话已清空');
    });

    // 从Spring Boot后端获取系统信息
    async function fetchSystemInfo() {
        try {
            const response = await fetch('/api/system/info');
            if (!response.ok) {
                throw new Error('获取系统信息失败');
            }
            return await response.json();
        } catch (error) {
            console.error('Error:', error);
            // 返回模拟数据作为后备
            return {
                cpuUsage: (Math.random() * 30 + 20).toFixed(2),
                memoryUsage: (Math.random() * 30 + 40).toFixed(2),
                storageUsage: (Math.random() * 20 + 10).toFixed(2),
                freeMemory: (8 * 1024 * (1 - Math.random() * 0.3)).toFixed(2),
                totalMemory: (8 * 1024).toFixed(2),
                freeStorage: (500 * (1 - Math.random() * 0.5)).toFixed(2),
                totalStorage: 500
            };
        }
    }

    // 更新系统状态显示
    async function updateSystemStatus() {
        const systemInfo = await fetchSystemInfo();

        // 直接使用后端返回的已格式化的两位小数数据
        document.getElementById('cpu-usage').textContent = `${systemInfo.cpuUsage}%`;
        document.querySelectorAll('.progress-bar')[0].style.width = `${systemInfo.cpuUsage}%`;

        document.getElementById('memory-usage').textContent = `${systemInfo.memoryUsage}%`;
        document.querySelectorAll('.progress-bar')[1].style.width = `${systemInfo.memoryUsage}%`;

        document.getElementById('storage-usage').textContent = `${systemInfo.storageUsage}%`;
        document.querySelectorAll('.progress-bar')[2].style.width = `${systemInfo.storageUsage}%`;

        // 其他数据保持原样
        document.getElementById('memory-detail').textContent =
            `已用: ${(systemInfo.totalMemory - systemInfo.freeMemory).toFixed(2)}MB   / 总计: ${systemInfo.totalMemory}MB`;
        document.getElementById('storage-detail').textContent =
            `已用: ${(systemInfo.totalStorage - systemInfo.freeStorage).toFixed(2)}MB   / 总计: ${systemInfo.totalStorage}MB`;
    }

    // 初始加载
    updateSystemStatus();
    // 每1秒更新一次
    setInterval(updateSystemStatus, 1000);
});
</script>

</body>
</html>