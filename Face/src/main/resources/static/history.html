<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat History Pagination</title>
    <link rel="stylesheet" href="/css/history.css">
</head>

<body>
<div id="chat-history"></div>
<div class="pagination-controls">
    <div class="pagination-info">Showing <span id="page-start">0</span>-<span id="page-end">0</span> of <span
            id="total-items">0</span> items</div>
    <div>
        <button id="prev-page" disabled>Previous</button>
        <button id="next-page">Next</button>
    </div>
</div>

<script>
    // æ¯é¡µæ˜¾ç¤ºçš„è®°å½•æ•°
    const itemsPerPage = 5;
    // å½“å‰é¡µç 
    let currentPage = 1;
    // æ€»è®°å½•æ•°
    let totalItems = 0;
    // å­˜å‚¨æ‰€æœ‰èŠå¤©è®°å½•
    let allChatHistory = [];

    // ç›‘å¬çˆ¶çª—å£å‘æ¥çš„æ¶ˆæ¯
    window.addEventListener('message',  function(event) {
        console.log(' æ”¶åˆ°æ¶ˆæ¯:', event.data);   // è°ƒè¯•ç”¨
        if (event.data  === 'show') {
            console.log(' å¼€å§‹åŠ è½½èŠå¤©è®°å½•...'); // è°ƒè¯•ç”¨
            loadChatHistory();
        }
    });

    // è·å–èŠå¤©è®°å½•çš„å‡½æ•°
    async function getChatHistory() {
        const userId = localStorage.getItem('id');
        console.log("User  ID:", userId);
        if (!userId) {
            throw new Error('User ID not found');
        }

        try {
            // æ„å»ºè¯·æ±‚ URL
            const response = await fetch(`/api/users/chatHistory?userId=${userId}`);

            if (!response.ok)  {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // è§£æå“åº”æ•°æ®
            const result = await response.json();
            console.log("API  Response:", result);

            if (result.code  !== 200) {
                throw new Error(result.msg  || 'Failed to fetch chat history');
            }

            allChatHistory = result.data  || [];
            totalItems = allChatHistory.length;
            return allChatHistory;
        } catch (error) {
            console.error('Error  fetching chat history:', error);
            alert('Error loading chat history: ' + error.message);
            return [];
        }
    }

    // æ¸²æŸ“èŠå¤©è®°å½•çš„å‡½æ•°
    function renderChatHistory() {
        const chatHistoryDiv = document.getElementById('chat-history');
        chatHistoryDiv.innerHTML  = '';

        // è®¡ç®—å½“å‰é¡µçš„æ•°æ®èŒƒå›´
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex  + itemsPerPage, totalItems);
        const currentPageData = allChatHistory.slice(startIndex,  endIndex);

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        document.getElementById('page-start').textContent  = startIndex + 1;
        document.getElementById('page-end').textContent  = endIndex;
        document.getElementById('total-items').textContent  = totalItems;

        if (currentPageData.length  === 0) {
            chatHistoryDiv.innerHTML  = '<p>ä½ è¿˜æ²¡æœ‰å¯¹è¯è®°å½•,å¿«å»ä¸AIå¯¹è¯å§ğŸ™‚</p>';
            return;
        }

        currentPageData.forEach(item  => {
            const chatItem = document.createElement('div');
            chatItem.className  = 'chat-item';

            const prompt = document.createElement('div');
            prompt.className  = 'chat-prompt';
            prompt.textContent  = `You: ${item.prompt  || 'N/A'}`;

            const response = document.createElement('div');
            response.className  = 'chat-response';
            // ä¿ç•™æ¢è¡Œå’Œæ ¼å¼
            response.innerHTML  = formatResponse(item.response  || 'N/A');

            const time = document.createElement('div');
            time.className  = 'chat-time';
            time.textContent  = formatTimestamp(item.timestamp);

            chatItem.appendChild(prompt);
            chatItem.appendChild(response);
            chatItem.appendChild(time);
            chatHistoryDiv.appendChild(chatItem);
        });
    }

    // æ ¼å¼åŒ–å“åº”å†…å®¹ï¼Œä¿ç•™æ¢è¡Œå’Œæ ¼å¼
    function formatResponse(text) {
        return text.replace(/\n/g,  '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }

    // æ ¼å¼åŒ–æ—¶é—´æˆ³
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString();
    }

    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€çš„å‡½æ•°
    function updatePaginationButtons() {
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');

        // ç¬¬ä¸€é¡µæ—¶ç¦ç”¨ä¸Šä¸€é¡µæŒ‰é’®
        prevPageButton.disabled  = currentPage === 1;
        // æœ€åä¸€é¡µæ—¶ç¦ç”¨ä¸‹ä¸€é¡µæŒ‰é’®
        nextPageButton.disabled  = currentPage * itemsPerPage >= totalItems;
    }

    // åŠ è½½èŠå¤©è®°å½•çš„å‡½æ•°
    async function loadChatHistory() {
        try {
            // é¦–æ¬¡åŠ è½½æ—¶è·å–æ‰€æœ‰æ•°æ®
            if (allChatHistory.length  === 0) {
                await getChatHistory();
            }
            renderChatHistory();
            updatePaginationButtons();
        } catch (error) {
            console.error('Error  in loadChatHistory:', error);
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
            const chatHistoryDiv = document.getElementById('chat-history');
            chatHistoryDiv.innerHTML  = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> åŠ è½½èŠå¤©è®°å½•å¤±è´¥: ${error.message}
                </div>
            `;
        }
    }

    // ä¸Šä¸€é¡µæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
    document.getElementById('prev-page').addEventListener('click',  () => {
        if (currentPage > 1) {
            currentPage--;
            renderChatHistory();
            updatePaginationButtons();
            window.scrollTo(0,  0);
        }
    });

    // ä¸‹ä¸€é¡µæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
    document.getElementById('next-page').addEventListener('click',  () => {
        if (currentPage * itemsPerPage < totalItems) {
            currentPage++;
            renderChatHistory();
            updatePaginationButtons();
            window.scrollTo(0,  0);
        }
    });

    // é¡µé¢åŠ è½½æ—¶åªåˆå§‹åŒ–åˆ†é¡µæŒ‰é’®
    document.addEventListener('DOMContentLoaded',  function() {
        updatePaginationButtons();
    });
</script>
</body>
</html>